# 舍不得删

以下代码片段是我舍不得删的代码。

## tcp数据分组算法(较差，能用)
```python
def package_message(data):
    """
    封包
    """
    res_pkg = MessageWindow.MESSAGE_BEGIN + str_to_hex(data) + MessageWindow.MESSAGE_END
    return res_pkg.encode()


class MessageWindow:
    """
    这段代码，我想了3天，还进行优化过，我真的舍不得删掉。
    虽然，我通过pymysql源码找到了更好的算法。

    消息窗口
    """

    # 数据包开始
    MESSAGE_BEGIN = 'K'
    # 数据包结束
    MESSAGE_END = 'J'

    def __init__(self):
        self._current_buffer = StringIO()
        self._message_window = Queue()

    def grouping_message(self, data):
        """
        对客户端发送来的数据组装，并分组
        :param data: str, 数据
        """
        start_count = -1
        end_count = -1

        if len(data) > 0:
            try:
                start_count = data.index(MessageWindow.MESSAGE_BEGIN)
            except ValueError:
                pass
            try:
                end_count = data.index(MessageWindow.MESSAGE_END)
            except ValueError:
                pass

            # `aaaa`
            if start_count == -1 and end_count == -1:
                self._current_buffer.write(data)

            # 正常数据：`Kaaa', 错误数据：`aaKaa'
            elif start_count != -1 and end_count == -1:
                if start_count != 0:
                    err_data = data[:start_count]
                    logging.info('客户端发送的数据可能被网络中被篡改：%s', err_data)

                self._current_buffer.write(data[start_count + 1:])

            # `Jaa`, `aaJaa`, `aaj`
            elif start_count == -1 and end_count != -1:
                self._current_buffer.write(data[:end_count])
                self._message_window.put_nowait(self._current_buffer.getvalue())
                self._current_buffer.close()
                self._current_buffer = StringIO()
                # self.current_buffer.truncate(0)
                # self.current_buffer.write(data[end_count + 1:])

            # `KaaJ`, `KaaJaa`, `aaKaaJaa`, `aaKaaJ`, `KaaJKaaJ`, `JaaK`, `JKaa`
            elif start_count != -1 and end_count != -1:
                if start_count < end_count:
                    self._current_buffer.truncate(0)
                    self._current_buffer.write(data[start_count + 1: end_count])
                    self._message_window.put_nowait(self._current_buffer.getvalue())
                    self._current_buffer.close()
                    self._current_buffer = StringIO()
                    self.grouping_message(data[end_count + 1:])
                else:
                    self._current_buffer.write(data[:end_count])
                    self._message_window.put_nowait(self._current_buffer.getvalue())
                    self._current_buffer.close()
                    self._current_buffer = StringIO()
                    self.grouping_message(data[start_count + 1:])

    def loop_message_window(self):
        """
        遍历消息窗口
        """
        while self._message_window.empty() is False:
            yield self._message_window.get_nowait()

    def finished(self):
        """
        是否结束读取
        """
        return self._message_window.qsize() > 0
```